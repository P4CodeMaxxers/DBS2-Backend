{% extends "layouts/base.html" %}
{% set project = "DBS2 Admin" %}

{% block body %}
<div class="container py-4">
    <header class="pb-3 mb-4 border-bottom border-primary text-light">
        <h1 class="fs-4">DBS2 Admin Dashboard</h1>
        <p class="text-muted">View all player data, leaderboard, and game statistics</p>
    </header>

    <!-- Leaderboard Section -->
    <div class="card bg-dark text-light mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">üèÜ Leaderboard (Ranked by Crypto)</h2>
            <small class="text-muted" id="leaderboardStatus">Auto-refreshing every 5s</small>
        </div>
        <div class="card-body">
            <table class="table table-dark table-striped" id="leaderboardTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>UID</th>
                        <th>Crypto</th>
                        <th>Minigames Completed</th>
                        <th>All Complete</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="6" class="text-center">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- All Players Section -->
    <div class="card bg-dark text-light mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">üë• All Players</h2>
            <button class="btn btn-sm btn-primary" onclick="loadPlayers()">Refresh</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-striped table-hover" id="playersTable">
                    <thead>
                        <tr>
                            <th>UID</th>
                            <th>Name</th>
                            <th>Crypto</th>
                            <th>Inventory</th>
                            <th>Scores</th>
                            <th>Progress</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playersBody">
                        <tr><td colspan="7" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div class="modal fade" id="playerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="playerModalTitle">Player Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="playerModalBody">
                    <!-- Player details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Crypto Modal -->
    <div class="modal fade" id="editCryptoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Crypto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editCryptoUID">
                    <div class="mb-3">
                        <label class="form-label">New Crypto Value</label>
                        <input type="number" class="form-control" id="editCryptoValue" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCrypto()">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = '/api/dbs2';

async function loadLeaderboard() {
    try {
        const statusEl = document.getElementById('leaderboardStatus');
        if (statusEl) {
            statusEl.textContent = 'Refreshing...';
        }
        
        const response = await fetch(`${API_BASE}/leaderboard?limit=10`);
        const data = await response.json();
        
        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = '';
        
        if (data.leaderboard && data.leaderboard.length > 0) {
            data.leaderboard.forEach(player => {
                const completedCount = [
                    player.completed_ash_trail,
                    player.completed_crypto_miner,
                    player.completed_whackarat,
                    player.completed_laundry,
                    player.completed_infinite_user
                ].filter(Boolean).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge ${player.rank <= 3 ? 'bg-warning text-dark' : 'bg-secondary'}">#${player.rank}</span></td>
                    <td>${player.user_info.name || 'Unknown'}</td>
                    <td><code>${player.user_info.uid || 'N/A'}</code></td>
                    <td><strong>${player.crypto}</strong> ü™ô</td>
                    <td>${completedCount}/5</td>
                    <td>${player.completed_all ? '‚úÖ' : '‚ùå'}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No players found</td></tr>';
        }
        
        if (statusEl) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            statusEl.textContent = `Auto-refreshing every 5s ‚Ä¢ Last updated: ${timeStr}`;
        }
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboardBody').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        const statusEl = document.getElementById('leaderboardStatus');
        if (statusEl) {
            statusEl.textContent = 'Error loading ‚Ä¢ Auto-refreshing every 5s';
        }
    }
}

async function loadPlayers() {
    try {
        const response = await fetch(`${API_BASE}/players`);
        const data = await response.json();
        
        const tbody = document.getElementById('playersBody');
        tbody.innerHTML = '';
        
        if (data.players && data.players.length > 0) {
            data.players.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${player.user_info.uid || 'N/A'}</code></td>
                    <td>${player.user_info.name || 'Unknown'}</td>
                    <td><strong>${player.crypto}</strong></td>
                    <td>${player.inventory.length} items</td>
                    <td>${Object.keys(player.scores).length} games</td>
                    <td>
                        ${player.completed_ash_trail ? 'üìö' : ''}
                        ${player.completed_crypto_miner ? '‚õèÔ∏è' : ''}
                        ${player.completed_whackarat ? 'üêÄ' : ''}
                        ${player.completed_laundry ? 'üß∫' : ''}
                        ${player.completed_infinite_user ? 'üíª' : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewPlayer('${player.user_info.uid}')">View</button>
                        <button class="btn btn-sm btn-warning" onclick="editCrypto('${player.user_info.uid}', ${player.crypto})">Edit Crypto</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No players found</td></tr>';
        }
    } catch (error) {
        console.error('Error loading players:', error);
        document.getElementById('playersBody').innerHTML = 
            '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
    }
}

async function viewPlayer(uid) {
    try {
        const response = await fetch(`${API_BASE}/player/${uid}`);
        const player = await response.json();
        
        document.getElementById('playerModalTitle').textContent = 
            `Player: ${player.user_info.name || uid}`;
        
        document.getElementById('playerModalBody').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Basic Info</h6>
                    <ul class="list-unstyled">
                        <li><strong>UID:</strong> ${player.user_info.uid}</li>
                        <li><strong>Name:</strong> ${player.user_info.name}</li>
                        <li><strong>Crypto:</strong> ${player.crypto} ü™ô</li>
                        <li><strong>Escaped:</strong> ${player.escaped ? 'Yes ‚úÖ' : 'No ‚ùå'}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Minigame Progress</h6>
                    <ul class="list-unstyled">
                        <li>üìö Ash Trail: ${player.completed_ash_trail ? '‚úÖ' : '‚ùå'}</li>
                        <li>‚õèÔ∏è Crypto Miner: ${player.completed_crypto_miner ? '‚úÖ' : '‚ùå'}</li>
                        <li>üêÄ Whack-a-Rat: ${player.completed_whackarat ? '‚úÖ' : '‚ùå'}</li>
                        <li>üß∫ Laundry: ${player.completed_laundry ? '‚úÖ' : '‚ùå'}</li>
                        <li>üíª Infinite User: ${player.completed_infinite_user ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>All Complete:</strong> ${player.completed_all ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <h6>Inventory (${player.inventory.length} items)</h6>
                    <ul class="list-group list-group-flush bg-dark">
                        ${player.inventory.length > 0 
                            ? player.inventory.map(item => `
                                <li class="list-group-item bg-dark text-light">
                                    <strong>${item.name}</strong> 
                                    <small class="text-muted">(found at: ${item.found_at})</small>
                                </li>
                            `).join('')
                            : '<li class="list-group-item bg-dark text-muted">No items</li>'
                        }
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>High Scores</h6>
                    <ul class="list-group list-group-flush bg-dark">
                        ${Object.keys(player.scores).length > 0 
                            ? Object.entries(player.scores).map(([game, score]) => `
                                <li class="list-group-item bg-dark text-light">
                                    <strong>${game}:</strong> ${score}
                                </li>
                            `).join('')
                            : '<li class="list-group-item bg-dark text-muted">No scores yet</li>'
                        }
                    </ul>
                </div>
            </div>
            <hr>
            <small class="text-muted">
                Created: ${player.created_at || 'N/A'}<br>
                Last Updated: ${player.updated_at || 'N/A'}
            </small>
        `;
        
        new bootstrap.Modal(document.getElementById('playerModal')).show();
    } catch (error) {
        console.error('Error loading player:', error);
        alert('Error loading player data');
    }
}

function editCrypto(uid, currentValue) {
    document.getElementById('editCryptoUID').value = uid;
    document.getElementById('editCryptoValue').value = currentValue;
    new bootstrap.Modal(document.getElementById('editCryptoModal')).show();
}

async function saveCrypto() {
    const uid = document.getElementById('editCryptoUID').value;
    const crypto = parseInt(document.getElementById('editCryptoValue').value);
    
    try {
        const response = await fetch(`${API_BASE}/player/${uid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ crypto: crypto })
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editCryptoModal')).hide();
            loadPlayers();
            loadLeaderboard();
        } else {
            alert('Error updating crypto');
        }
    } catch (error) {
        console.error('Error saving crypto:', error);
        alert('Error saving changes');
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadLeaderboard();
    loadPlayers();
    
    // Auto-refresh leaderboard every 5 seconds
    setInterval(() => {
        loadLeaderboard();
    }, 5000); // 5000 milliseconds = 5 seconds
});
</script>
{% endblock %}